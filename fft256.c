/*
 * fftSw.c
 *
 *  Created on: 02-Dec-2022
 *      Author: syedd
 */


#define FFTSIZE 256 		/* FFTSIZE OF FFT */
#define FFTSTAGES 8 			/* Number of Stages = Log2N */

typedef float DTYPE;
typedef unsigned int INTTYPE;
const DTYPE W_real[]={1,0.999698818696204,0.998795456205172,0.99729045667869,0.995184726672197,0.99247953459871,0.989176509964781,0.985277642388941,0.98078528040323,0.975702130038529,0.970031253194544,0.96377606579544,0.956940335732209,0.949528180593037,0.941544065183021,0.932992798834739,0.923879532511287,0.914209755703531,0.903989293123443,0.893224301195515,0.881921264348355,0.870086991108711,0.857728610000272,0.844853565249707,0.831469612302545,0.817584813151584,0.803207531480645,0.788346427626606,0.773010453362737,0.757208846506485,0.740951125354959,0.724247082951467,0.707106781186548,0.689540544737067,0.671558954847018,0.653172842953777,0.634393284163645,0.615231590580627,0.595699304492433,0.575808191417845,0.555570233019602,0.534997619887097,0.514102744193222,0.492898192229784,0.471396736825998,0.449611329654607,0.427555093430282,0.40524131400499,0.38268343236509,0.359895036534988,0.33688985339222,0.313681740398892,0.290284677254462,0.266712757474898,0.242980179903264,0.21910124015687,0.195090322016128,0.170961888760301,0.146730474455362,0.122410675199216,0.0980171403295608,0.0735645635996675,0.0490676743274181,0.0245412285229123,6.12323399573677e-17,-0.0245412285229121,-0.049067674327418,-0.0735645635996673,-0.0980171403295606,-0.122410675199216,-0.146730474455362,-0.170961888760301,-0.195090322016128,-0.21910124015687,-0.242980179903264,-0.266712757474898,-0.290284677254462,-0.313681740398891,-0.33688985339222,-0.359895036534988,-0.38268343236509,-0.40524131400499,-0.427555093430282,-0.449611329654607,-0.471396736825998,-0.492898192229784,-0.514102744193222,-0.534997619887097,-0.555570233019602,-0.575808191417845,-0.595699304492433,-0.615231590580627,-0.634393284163645,-0.653172842953777,-0.671558954847018,-0.689540544737067,-0.707106781186547,-0.724247082951467,-0.740951125354959,-0.757208846506485,-0.773010453362737,-0.788346427626606,-0.803207531480645,-0.817584813151584,-0.831469612302545,-0.844853565249707,-0.857728610000272,-0.870086991108711,-0.881921264348355,-0.893224301195515,-0.903989293123443,-0.914209755703531,-0.923879532511287,-0.932992798834739,-0.941544065183021,-0.949528180593037,-0.956940335732209,-0.96377606579544,-0.970031253194544,-0.975702130038528,-0.98078528040323,-0.985277642388941,-0.989176509964781,-0.99247953459871,-0.995184726672197,-0.99729045667869,-0.998795456205172,-0.999698818696204};
const DTYPE W_imag[]={-0,-0.0245412285229123,-0.049067674327418,-0.0735645635996674,-0.0980171403295606,-0.122410675199216,-0.146730474455362,-0.170961888760301,-0.195090322016128,-0.21910124015687,-0.242980179903264,-0.266712757474898,-0.290284677254462,-0.313681740398892,-0.33688985339222,-0.359895036534988,-0.38268343236509,-0.40524131400499,-0.427555093430282,-0.449611329654607,-0.471396736825998,-0.492898192229784,-0.514102744193222,-0.534997619887097,-0.555570233019602,-0.575808191417845,-0.595699304492433,-0.615231590580627,-0.634393284163645,-0.653172842953777,-0.671558954847018,-0.689540544737067,-0.707106781186547,-0.724247082951467,-0.740951125354959,-0.757208846506485,-0.773010453362737,-0.788346427626606,-0.803207531480645,-0.817584813151584,-0.831469612302545,-0.844853565249707,-0.857728610000272,-0.870086991108711,-0.881921264348355,-0.893224301195515,-0.903989293123443,-0.914209755703531,-0.923879532511287,-0.932992798834739,-0.941544065183021,-0.949528180593037,-0.956940335732209,-0.96377606579544,-0.970031253194544,-0.975702130038529,-0.98078528040323,-0.985277642388941,-0.989176509964781,-0.99247953459871,-0.995184726672197,-0.99729045667869,-0.998795456205172,-0.999698818696204,-1,-0.999698818696204,-0.998795456205172,-0.99729045667869,-0.995184726672197,-0.99247953459871,-0.989176509964781,-0.985277642388941,-0.98078528040323,-0.975702130038529,-0.970031253194544,-0.96377606579544,-0.956940335732209,-0.949528180593037,-0.941544065183021,-0.932992798834739,-0.923879532511287,-0.914209755703531,-0.903989293123443,-0.893224301195515,-0.881921264348355,-0.870086991108711,-0.857728610000272,-0.844853565249707,-0.831469612302545,-0.817584813151584,-0.803207531480645,-0.788346427626606,-0.773010453362737,-0.757208846506485,-0.740951125354959,-0.724247082951467,-0.707106781186548,-0.689540544737067,-0.671558954847019,-0.653172842953777,-0.634393284163645,-0.615231590580627,-0.595699304492433,-0.575808191417845,-0.555570233019602,-0.534997619887097,-0.514102744193222,-0.492898192229784,-0.471396736825998,-0.449611329654607,-0.427555093430282,-0.40524131400499,-0.38268343236509,-0.359895036534988,-0.33688985339222,-0.313681740398891,-0.290284677254462,-0.266712757474898,-0.242980179903264,-0.21910124015687,-0.195090322016129,-0.170961888760301,-0.146730474455362,-0.122410675199216,-0.0980171403295608,-0.0735645635996677,-0.049067674327418,-0.0245412285229123};


#define reverse(n) ((n & 0x1) << 7) | ((n & 0x2) << 5) | ((n & 0x4) << 3) | ((n & 0x8) << 1) | ((n & 0x10) >> 1) | ((n & 0x20) >> 3) | ((n & 0x40) >> 5) | ((n & 0x80) >> 7)

void FFT_sw(float FFTIn_I[FFTSIZE], float FFTIn_R[FFTSIZE], float FFTOut_I[FFTSIZE], float FFTOut_R[FFTSIZE])
{

  DTYPE temp_R;   /*temporary storage complex variable*/
  DTYPE temp_I;   /*temporary storage complex variable*/

  int i,j;      /* loop indexes */
  int i_lower;    /* Index of lower point in butterfly */

  int stage;
  int subDFTSize; //Size of DFT in each stage of FFT
  int BFWidth;      /*Butterfly Width*/

  /*=====================BEGIN BIT REBERSAL===========================*/
  for (i = 0; i < FFTSIZE; ++i) {
    FFTOut_R[reverse(i)] = FFTIn_R[i];
    FFTOut_I[reverse(i)] = FFTIn_I[i];
  }
  /*++++++++++++++++++++++END OF BIT REVERSAL++++++++++++++++++++++++++*/

  /*=======================BEGIN: FFT=========================*/
  // Do FFTSTAGES of butterflies
  DTYPE BFWeight_cos, BFWeight_sin;
 // For N-point FFT, there are log2(N) stages
  stages:for(stage=1; stage<= FFTSTAGES; stage++)
  {
    subDFTSize = 1 << stage;    // DFT = 2^stage = points in sub DFT
    BFWidth = subDFTSize >> 1;       // Butterfly WIDTHS in sub-DFT (FFTSIZE of sub-DFT/2)
    // Perform butterflies for j-th stage
    // This loop runs for the iteration equal to BF width
    // In 4-point FFT, BF width is 1 in stage 1 and 2 in stage 2
    // In 8-point FFT, BF width is 1 in stage 1, 2 in stage 2 and 4 in stage 3
    butterfly:for(j=0; j<BFWidth; j++)
    {
    	BFWeight_cos = W_real[j * (FFTSIZE>>stage)];
    	BFWeight_sin = W_imag[j * (FFTSIZE>>stage)];

		// This loop is for all butterflies in a stage that use same W**k
		// In 4-point FFT, we have two BFs in stage 1
		// In 8-point FFT, we have four BFs in stage 1 and two BFs in stage 2
		subDFTSize:for(i =j ; i < FFTSIZE; i += subDFTSize)
		  {
			i_lower = i + BFWidth;      //index of lower point in butterfly
			temp_R = FFTOut_R[i_lower] * BFWeight_cos - FFTOut_I[i_lower] * BFWeight_sin;
			temp_I = FFTOut_I[i_lower] * BFWeight_cos + FFTOut_R[i_lower] * BFWeight_sin;

			FFTOut_R[i_lower] = FFTOut_R[i] - temp_R;//- temp_R;
			FFTOut_I[i_lower] = FFTOut_I[i] - temp_I;
			FFTOut_R[i] = FFTOut_R[i] + temp_R;
			FFTOut_I[i] = FFTOut_I[i] + temp_I;
		  }
	}
  }
}
